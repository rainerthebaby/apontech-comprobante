<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>GMB | Digital Service Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  margin:0;
  padding:16px;
  font-family: system-ui, sans-serif;
  background:#ffffff;
  color:#0f172a;
}
.container{max-width:600px;margin:auto;}
.logo{display:block;margin:0 auto 10px;max-width:180px;}
h1{text-align:center;font-size:22px;margin-bottom:20px;}

.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}

label{font-size:14px;font-weight:600;}
input,textarea,select{
  width:100%;
  margin-top:6px;
  padding:12px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  font-size:15px;
}

canvas{
  width:100%;
  height:180px;
  border-radius:12px;
  border:1px dashed #cbd5f5;
  background:#f8fafc;
  touch-action:none;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#2563eb,#22c55e);
  color:#fff;
  font-size:16px;
  font-weight:600;
  margin-top:8px;
}

button i{margin-right:8px;}

.secondary{background:#64748b;}
.danger{background:#ef4444;}

.small{text-align:center;font-size:12px;color:#64748b;margin-top:6px;}
.footer{text-align:center;font-size:13px;color:#475569;margin-top:20px;}
</style>
</head>

<body>

<div class="container">

<img src="logo.png" class="logo">

<h1>Digital Service Report</h1>

<div class="card">
  <label><i class="fa-solid fa-user" style="color:#2563eb"></i> Driver</label>
<input id="driver">

<label style="margin-top:12px;">
   
  <i class="fa-solid fa-location-dot" style="color:#ef4444"></i> Service Address
</label>
<textarea id="address"></textarea>

</div>

<div class="card">
  <label>Service Photos</label>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>


  <button class="secondary" onclick="cameraInput.click()">
    <i class="fa-solid fa-camera"></i> Take Photos
  </button>

  <input type="file" id="galleryInput" accept="image/*" multiple hidden>
  <button class="secondary" onclick="galleryInput.click()">
    <i class="fa-regular fa-image"></i> Choose from Gallery
  </button>

  <div class="small" id="photoCount">0 photos selected</div>
</div>

<div class="card">
  <label>Service Performed</label>
  <div id="serviceLines"></div>

  <button class="secondary" onclick="addLine()">
    <i class="fa-solid fa-plus"></i> Add Service Line
  </button>
</div>

<div class="card">
  <label>Customer Signature</label>
  <canvas id="signature"></canvas>
  <button class="danger" onclick="clearSig()">
    <i class="fa-solid fa-eraser"></i> Clear Signature
  </button>
</div>

<div class="card">
  <button onclick="generatePDF()">
    <i class="fa-solid fa-file-pdf"></i> Generate PDF
  </button>
</div>

<div class="footer">
GMB Window & Bathub Company<br>
Phone: +1 (646) 671-6849<br>
Email: Gemibrand@gmail.com
</div>

</div>

<script>
function getReportNumber(){
  const name = document.getElementById("driver").value.trim();

  let initials = "XX";
  if(name){
    const parts = name.split(" ").filter(p => p.length);
    initials = parts[0][0].toUpperCase();
    if(parts.length > 1) initials += parts[1][0].toUpperCase();
  }

  const today = new Date();
  const dateStr = today.getFullYear().toString() +
    String(today.getMonth()+1).padStart(2,"0") +
    String(today.getDate()).padStart(2,"0");

  const key = `GMB_${dateStr}_${initials}`;
  let count = localStorage.getItem(key);
  count = count ? parseInt(count) + 1 : 1;

  localStorage.setItem(key, count);

  return `GMB-${dateStr}-${initials}-${String(count).padStart(3,"0")}`;
}



const canvas = document.getElementById("signature");
const ctx = canvas.getContext("2d");
let drawing = false;
let images = [];

function resize(){
  const data = canvas.toDataURL(); // guardar firma

  canvas.width = canvas.offsetWidth;
  canvas.height = 180;

  if (data !== "data:,") {
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0, 0);
    img.src = data;
  }
}
resize();
window.onresize = resize;

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("pointermove", e => {
  if(!drawing) return;
  ctx.lineWidth = 2.5;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#2563eb";
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup", () => drawing = false);

function clearSig(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

cameraInput.onchange = e => {
  if (!e.target.files.length) return;

  images.push(e.target.files[0]);
  photoCount.innerText = `${images.length} photos selected`;

  cameraInput.value = ""; // permite tomar otra foto seguida
};

galleryInput.onchange = e => {
  for (let file of e.target.files) {
    images.push(file);
  }
  photoCount.innerText = `${images.length} photos selected`;
};


function addLine(){

  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.gap = "8px";
  row.style.marginTop = "8px";

  row.innerHTML = `
    <select class="area">
      <option value="">Area</option>
      <option>Bathroom</option>
      <option>Living Room</option>
      <option>Kitchen</option>
      <option>Bedroom</option>
    </select>

    <select class="service">
      <option value="">Service</option>
      <option>Repair</option>
      <option>Glass</option>
      <option>Installation</option>
      <option>Bathtub</option>
    </select>

	 <input type="number" class="qty" placeholder="Qty" min="1" value="1" 
      style="width:70px;padding:10px;border-radius:10px;border:1px solid #e5e7eb;">
	
    <button class="danger" onclick="this.parentElement.remove()">
      <i class="fa-solid fa-trash"></i>
    </button>
  `;

  serviceLines.appendChild(row);
}

async function generatePDF(){

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const now = new Date().toLocaleString();
  const number = getReportNumber();

  pdf.addImage("logo.png","PNG",15,10,40,20);
  pdf.setFontSize(16);
  pdf.text("GMB WINDOW & BATHUB COMPANY",105,18,{align:"center"});
  pdf.setFontSize(12);
  pdf.text("SERVICE REPORT",105,26,{align:"center"});
  pdf.line(10,32,200,32);

  pdf.rect(10,38,190,32);
  pdf.setFontSize(11);
  pdf.text(`Report #: ${number}`,15,46);
  pdf.text(`Date & Time: ${now}`,15,54);
  pdf.text(`Technician: ${driver.value}`,110,46);
  pdf.text("Address:",110,54);
  pdf.text(address.value,110,60,{maxWidth:85});

 let y = 86;

/* ===== SERVICE TABLE FIRST ===== */

pdf.setFontSize(13);
pdf.text("SERVICE DETAILS",10,y);
y += 10;

pdf.setFillColor(37,99,235);
pdf.rect(12,y-7,186,9,"F");

pdf.setTextColor(255,255,255);
pdf.setFontSize(11);
pdf.text("Area",15,y);
pdf.text("Service",85,y);
pdf.text("Qty",170,y);

y += 8;
pdf.setTextColor(0,0,0);

const areas = document.querySelectorAll(".area");
const services = document.querySelectorAll(".service");
const qtys = document.querySelectorAll(".qty");

let stripe = false;

for(let i=0;i<areas.length;i++){

  if(!areas[i].value || !services[i].value) continue;

  if(y > 180){
    pdf.addPage();
    y = 20;
  }

  if(stripe){
    pdf.setFillColor(245,247,250);
    pdf.rect(12,y-6,186,9,"F");
  }

  pdf.setDrawColor(220,220,220);
  pdf.rect(12,y-6,186,9);

  pdf.text(areas[i].value,15,y);
  pdf.text(services[i].value,85,y);
  pdf.text(qtys[i].value || "1",170,y);

  stripe = !stripe;
  y += 10;
}

y += 15;

if(y > 180){
  pdf.addPage();
  y = 20;
}

/* ===== PHOTOS AFTER TABLE ===== */

pdf.setFontSize(13);
pdf.text("EVIDENCE",10,y);
y += 6;

let x = 15;
let col = 0;

for (let i = 0; i < images.length; i++) {

  const img = await read(images[i]);

  if (y > 215) {
    pdf.addPage();
    y = 20;
    x = 15;
    col = 0;
  }

  pdf.addImage(img, "PNG", x, y, 80, 55);

  if (col === 0) {
    x = 110;
    col = 1;
  } else {
    x = 15;
    col = 0;
    y += 60;
  }
}

if (col === 1) y += 70;
y += 10;

  

  y += 14;

  if(y > 160){
    pdf.addPage();
    y = 20;
  }

  /* ===== COMPLETED BOX ===== */

  pdf.setFillColor(220,245,230);
  pdf.setDrawColor(40,150,80);
  pdf.roundedRect(12, y, 186, 32, 4, 4, "F");

  pdf.setFontSize(12);
  pdf.text("Service Completed Successfully",105,y+10,{align:"center"});
  pdf.setFontSize(10);
  pdf.text("Thank you for trusting our professional team.",105,y+18,{align:"center"});
  pdf.text("We appreciate your business and look forward to serving you again.",105,y+26,{align:"center"});

  y += 42;

  if(y > 160){
    pdf.addPage();
    y = 20;
  }

  pdf.addImage(canvas.toDataURL(),"PNG",15,y+12,90,40);
  pdf.line(15,y+50,105,y+50);
  pdf.text("CUSTOMER SIGNATURE",15,y+58);

  pdf.line(10,280,200,280);
  pdf.text(
    "GMB Window & Bathub Company | +1 (646) 671-6849 | Gemibrand@gmail.com",
    105,287,{align:"center"}
  );

  const blob = pdf.output("blob");
  const file = new File([blob], "GMB_Service_Report.pdf", { type: "application/pdf" });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    await navigator.share({ files: [file] });
  } else {
    pdf.save("GMB_Service_Report.pdf");
  }
}


function read(file){
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.readAsDataURL(file);
  });
}
</script>

</body>
</html>